<!DOCTYPE html>
<html>
<head>
    <title>Spectrum High-Split Rollout</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: white;}
        #map { height: 85vh; width: 100%; }
        #controls { padding: 15px; background: #2c3e50; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;}
        h2 { margin: 0 20px 0 0; font-size: 1.2rem;}
        .slider-container { flex-grow: 1; margin: 0 20px; display: flex; align-items: center;}
        input[type=range] { width: 100%; margin-right: 15px; cursor: pointer;}
        #dateLabel { font-family: monospace; font-size: 1.2rem; background: #34495e; padding: 5px 10px; border-radius: 4px;}
        .legend { font-size: 0.9rem; }
        .dot { height: 10px; width: 10px; display: inline-block; border-radius: 50%; margin-right: 5px;}
    </style>
</head>
<body>

<div id="controls">
    <h2>ðŸ“¡ High-Split Tracker</h2>
    <div class="slider-container">
        <input type="range" id="timeSlider" min="0" max="0" step="1">
        <span id="dateLabel">Loading...</span>
    </div>
    <div class="legend">
        <span class="dot" style="background:#3388ff;"></span>Existing
        <span class="dot" style="background:#2ecc71; margin-left:10px;"></span>New
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Initialize Map
    var map = L.map('map').setView([39.8283, -98.5795], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        maxZoom: 19
    }).addTo(map);

    var layerGroup = L.layerGroup().addTo(map);
    var historyData = [];

    // 2. Load Data
    fetch('data/history.json')
        .then(response => response.json())
        .then(data => {
            historyData = data;
            setupSlider();
        })
        .catch(err => {
            console.error("Could not load data. Ensure scrape.py has run at least once.", err);
            document.getElementById('dateLabel').innerText = "No Data Yet";
        });

    // 3. Setup Slider
    function setupSlider() {
        var slider = document.getElementById('timeSlider');
        slider.max = historyData.length - 1;
        slider.value = historyData.length - 1; // Start at end
        
        updateMap(slider.value);

        slider.addEventListener('input', function(e) {
            updateMap(e.target.value);
        });
    }

    // 4. Render Map Logic
    function updateMap(index) {
        index = parseInt(index);
        var snapshot = historyData[index];
        var prevSnapshot = index > 0 ? historyData[index - 1] : null;
        
        document.getElementById('dateLabel').innerText = snapshot.date;
        layerGroup.clearLayers();

        // Build set of previous cities to detect "New" ones
        var prevCities = new Set();
        if (prevSnapshot) {
            prevSnapshot.cities.forEach(c => prevCities.add(c.city));
        }

        snapshot.cities.forEach(place => {
            var isNew = (index > 0) && !prevCities.has(place.city);
            
            // Standard Blue Marker
            var color = "#3388ff"; 
            var radius = 6000;
            
            // New (Green) Marker
            if (isNew) {
                color = "#2ecc71";
                radius = 12000; // Make it pop
            }

            var circle = L.circle([place.lat, place.lon], {
                color: color,
                fillColor: color,
                fillOpacity: 0.7,
                radius: radius
            }).bindPopup(`<b>${place.city}</b><br>${isNew ? "âœ¨ NEW UPDATE!" : "Status: Active"}`);

            layerGroup.addLayer(circle);
        });
    }
</script>
</body>
</html>